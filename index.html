<!DOCTYPE html>
<html>
<head>
    <title>kline</title>
    <meta charset="utf-8">
    <style type="text/css">
        *{
            margin:0px;
            padding:0px;
        }
        #loading{
            position: absolute;
            width: 200px;
            height: 200px;
            left: 50%;
            margin-left:-100px;
            top: 50%;
            margin-top: -100px;
            z-index: 99999999;
            background: url('./img/loading.gif') center center no-repeat;
            background-size:30% 30%;
            display: none;
        }
    </style>
</head>
<body>
<div class="hello">
    <div id="chart_container" class="f-fill" style="height:600px;"></div>
    <span id="loading"></span>
 </div>
 <script src="./jquery.js"></script>
 <script type="text/javascript" src='./static/custom_scripts/chart_main/charting_library.min.js'></script>

 <script type="text/javascript">
    var currency1='USDT',currency2='BTC',saved_chart=null,chart=null,feed=null,timer=30000,pushtimer=null,last_price,bars=[],chart=null,MainData=null,CodeName='',timers=null,status=1,timer_kline=null;
    var loading=document.getElementById('loading');
    var overallTime;
    // var dataurl="http://"+window.location.host+"/home/Ajax/index?pageSize=500&page=1&goodsType=";
    var dataurl="http://"+"www.scex.pro"+"/home/Ajax/index?pageSize=500&page=1&goodsType=";
	
    var wsurl = "ws://"+"www.scex.pro:7272";
    //  var wsurl = "ws://"+window.location.host+":7272";
    var timerws = null;
    function GetQueryString(name){ //截取url
        var reg = new RegExp("(^|&|)" + name + "=([^&?]*)(&|$|)", "i");  
        var r = window.location.search.substr(1).match(reg);  //获取url中"?"符后的字符串并正则匹配
        var context = "";  
        if (r != null)  
            context = r[2];  
            reg = null;  
            r = null;  
            return context == null || context == "" || context == "undefined" ? "" : context;   
    };
    // 除法
    function Division (a, b) {
        var a = a == '' ? 0 : a
        var b = b == '' ? 0 : b
        var c, d, e = 0,
            f = 0
        try {
            e = a.toString().split('.')[1].length
        } catch (g) {}
        try {
            f = b.toString().split('.')[1].length
        } catch (g) {}
        return c = Number(a.toString().replace('.', '')), d = Number(b.toString().replace('.', '')), mul(c / d, Math.pow(10, f - e))
    };
    function mul (a, b) {
        var c = 0,
            d = a.toString(),
            e = b.toString()
        try {
            c += d.split('.')[1].length
        } catch (f) {}
        try {
            c += e.split('.')[1].length
        } catch (f) {}
        return Number(d.replace('.', '')) * Number(e.replace('.', '')) / Math.pow(10, c)
    }
    // 时间转化
    function timestampToTime (timestamp) {
        if (String(timestamp).length<13) {
            var date = new Date(timestamp * 1000) //时间戳为10位需*1000，时间戳为13位的话不需乘1000
        } else {
            var date = new Date(timestamp);
        }
        var Y, M, D, h, m, s
        Y = date.getFullYear() + '-'
        M = (date.getMonth() < 10 ? '0' + (date.getMonth() + 1) : date.getMonth() + 1) + '-'
        D = (date.getDate() < 10 ? '0' + (date.getDate()) : date.getDate()) + ' '
        h = (date.getHours() < 10 ? '0' + (date.getHours()) : date.getHours()) + ':'
        m = (date.getMinutes()< 10 ? '0' + (date.getMinutes()) : date.getMinutes()) + ':'
        s = (date.getSeconds()< 10 ? '0' + (date.getSeconds()) : date.getSeconds())
        return new Date(Y + M + D + h + m).getTime()
    }

    CodeName=GetQueryString('code');
    timers=GetQueryString('timers') || 1;
    label=GetQueryString('label') || label;
    last_price=GetQueryString('last_price');

    if(timers=='1' ){
        getChartData(dataurl+'minute&code='+CodeName);
    } else if(timers=='1D'){
        getChartData(dataurl+'day&code='+CodeName);
    } else if(timers == '1W'){
        getChartData(dataurl+'week&code='+CodeName);
    } else if(timers == '240'){
        getChartData(dataurl+'hour4&code='+CodeName);
    } else if(timers == '1M'){
        getChartData(dataurl+'month&code='+CodeName);
    } else {
        getChartData(dataurl+'minute'+timers+'&code='+CodeName);
    }

    if(getCookie('language')=='Chinese'){
        local="zh";
    }else{
        local="en";
    }
     
 if(getCookie("changeBg") == 'night' || !getCookie("changeBg")) {
     localStorage.clear();
     var _bgColor = {
        mainBg: '#131e30', //主要背景颜色
        asideBg: '#131e30', //工具边框颜色
        hengline: '#344568', //横线
        shuline: '#344568', //竖线
        backgroundColor:'#131e30',
        foregroundColor:'#181B2A',              
     }
 } else {
     localStorage.clear();
     var _bgColor = {                
        mainBg: '#fff', //主要背景颜色
        asideBg: '#fff', //工具边框颜色
        hengline: '#eee', //横线
        shuline: '#eee', //竖线
        backgroundColor:'#fff',
        foregroundColor:'#fff',     
     }
 };
    var feed =createFeed();
    TradingView.onready(function (configurationData) {
        loading.style.display='block';
        chart = window.tvWidget = new TradingView.widget({
            fullscreen: false,
            autosize: true,
            symbol:CodeName,
            container_id: "chart_container",
            datafeed: feed,
            library_path: "static/custom_scripts/chart_main/",
            locale: local,
            timezone: 'Asia/Shanghai', //todo: ustawianie timezone'a po strefie usera
            charts_storage_api_version: "1.1",
            client_id: 'tradingview.com',
            user_id: 'public_user_id',
            minmov : 1,
            pricecale : 10000,
            minmove2 : 0,
            loading_screen: {
                backgroundColor: _bgColor.backgroundColor,
                foregroundColor: _bgColor.foregroundColor,
            }, //todo:do it  加载背景色
            // debug: true,
            //loading_screen:{ backgroundColor: "#000000",foregroundColor: "#000000", }//todo:do it
            interval: timers,
            // timeframe:'',//todo: na koncu
            toolbar_bg: _bgColor.asideBg,//工具栏背景颜色
            // saved_data: savedData,
            allow_symbol_change: true,
            time_frames: [
                {text: "1y", resolution: "1W"},
                {text: "6m", resolution: "3D"},
                {text: "3m", resolution: "1D"},
                {text: "1m", resolution: "1D"},
                {text: "1w", resolution: "30"},
                {text: "3d", resolution: "30"},
                {text: "1d", resolution: "30"},
                {text: "6h", resolution: "15"},
                {text: "1h", resolution: "1"}],
            drawings_access: {
                type: 'black',
                // tools: [{name: "Regression Trend"}]//todo: moje
                tools: [{name: "Trend Line", grayed: true}, {name: "Trend Angle", grayed: true}] //todo: bb
            },
            disabled_features: [
                        "header_symbol_search",
                        "header_interval_dialog_button",
                        "show_interval_dialog_on_key_press",
                        "symbol_search_hot_key",
                        "study_dialog_search_control",
                        "display_market_status",
                        "header_compare",
                        "symbol_info",
                        "border_around_the_chart",
                        "main_series_scale_menu",
                        "star_some_intervals_by_default",
                        "datasource_copypaste",
                        "right_bar_stays_on_scroll",
                        "context_menus",
                        "go_to_date",
                        "compare_symbol",
                        "border_around_the_chart",
                        "timezone_menu",
                        // "legend_context_menu",
                        "header_resolutions", //todo: przetestowac
                        "control_bar", //todo: przetestowac
                        //"edit_buttons_in_legend",//todo: przetestowac
                        "remove_library_container_border",
                        "volume_force_overlay",
                        // "dont_show_boolean_study_arguments",
                    ],
                    enabled_features: [
                        "use_localstorage_for_settings",
                        "remove_library_container_border",
                        "save_chart_properties_to_local_storage",
                        "side_toolbar_in_fullscreen_mode",
                        "hide_last_na_study_output",
                        "constraint_dialogs_movement", //todo: nie do końca jestem pewien
                        "legend_context_menu",
                        "dont_show_boolean_study_arguments",
                        "edit_buttons_in_legend",
                    ],
                    studies_overrides: {
                        "volume.volume.color.0": "#fe4761",
                        "volume.volume.color.1": "#3fcfb4",
                        "volume.volume.transparency": 75,
                    },
                    overrides: {
                        "symbolWatermarkProperties.color": "rgba(0,0,0, 0)",
                        "paneProperties.background": _bgColor.mainBg, //背景颜色
                        "paneProperties.vertGridProperties.color": _bgColor.hengline, //横线
                        "paneProperties.horzGridProperties.color": _bgColor.shuline, //竖线
                        "paneProperties.crossHairProperties.color": "#58637a", //这个不知道是什么颜色
                        "paneProperties.crossHairProperties.style": 1,
                        "mainSeriesProperties.style": 9,
                        "mainSeriesProperties.showCountdown": false,
                        "scalesProperties.showSeriesLastValue": true,
                        "mainSeriesProperties.visible": false,
                        "mainSeriesProperties.showPriceLine": true,
                        "mainSeriesProperties.priceLineWidth": 1,
                        "mainSeriesProperties.lockScale": false,
                        "mainSeriesProperties.minTick": "default",
                        "mainSeriesProperties.extendedHours": false,
                        "volumePaneSize": "medium",
                        editorFontsList: ["Lato", "Arial", "Verdana", "Courier New", "Times New Roman"],
                        "paneProperties.topMargin": 5,
                        "paneProperties.bottomMargin": 5,
                        "paneProperties.leftAxisProperties.autoScale": true,
                        "paneProperties.leftAxisProperties.autoScaleDisabled": false,
                        "paneProperties.leftAxisProperties.percentage": false,
                        "paneProperties.leftAxisProperties.percentageDisabled": false,
                        "paneProperties.leftAxisProperties.log": false,
                        "paneProperties.leftAxisProperties.logDisabled": false,
                        "paneProperties.leftAxisProperties.alignLabels": true,
                        "paneProperties.legendProperties.showStudyArguments": false,
                        "paneProperties.legendProperties.showStudyTitles": true,
                        "paneProperties.legendProperties.showStudyValues": true,
                        "paneProperties.legendProperties.showSeriesTitle": true,
                        "paneProperties.legendProperties.showSeriesOHLC": true,
                        "scalesProperties.showLeftScale": false,
                        "scalesProperties.showRightScale": true,
                        "scalesProperties.backgroundColor": "#1b1b40",
                        "scalesProperties.lineColor": "#46587b",
                        "scalesProperties.textColor": "#8f98ad",
                        "scalesProperties.scaleSeriesOnly": false,
                        "mainSeriesProperties.priceAxisProperties.autoScale": true,
                        "mainSeriesProperties.priceAxisProperties.autoScaleDisabled": false,
                        "mainSeriesProperties.priceAxisProperties.percentage": false,
                        "mainSeriesProperties.priceAxisProperties.percentageDisabled": false,
                        "mainSeriesProperties.priceAxisProperties.log": false,
                        "mainSeriesProperties.priceAxisProperties.logDisabled": false,
                        "mainSeriesProperties.candleStyle.upColor":"#3fcfb4" , // #fe4761 红色  #3fcfb4 绿色
                        "mainSeriesProperties.candleStyle.downColor": "#fe4761",
                        "mainSeriesProperties.candleStyle.drawWick": true,
                        "mainSeriesProperties.candleStyle.drawBorder": true,
                        "mainSeriesProperties.candleStyle.borderColor": "#3fcfb4",  // ?
                        "mainSeriesProperties.candleStyle.borderUpColor":  "#3fcfb4",
                        "mainSeriesProperties.candleStyle.borderDownColor":"#fe4761",
                        "mainSeriesProperties.candleStyle.wickColor": "#737375",   // ?
                        "mainSeriesProperties.candleStyle.wickUpColor":"#3fcfb4" ,
                        "mainSeriesProperties.candleStyle.wickDownColor": "#fe4761",
                        "mainSeriesProperties.candleStyle.barColorsOnPrevClose": false,
                        "mainSeriesProperties.hollowCandleStyle.upColor": "#3fcfb4",
                        "mainSeriesProperties.hollowCandleStyle.downColor": "#fe4761",
                        "mainSeriesProperties.hollowCandleStyle.drawWick": true,
                        "mainSeriesProperties.hollowCandleStyle.drawBorder": true,
                        "mainSeriesProperties.hollowCandleStyle.borderColor": "#3fcfb4",
                        "mainSeriesProperties.hollowCandleStyle.borderUpColor": "#3fcfb4",
                        "mainSeriesProperties.hollowCandleStyle.borderDownColor": "#fe4761",
                        "mainSeriesProperties.hollowCandleStyle.wickColor": "#737375",
                        "mainSeriesProperties.hollowCandleStyle.wickUpColor": "#3fcfb4",
                        "mainSeriesProperties.hollowCandleStyle.wickDownColor": "#fe4761",
                        "mainSeriesProperties.haStyle.upColor": "#3fcfb4",
                        "mainSeriesProperties.haStyle.downColor": "#fe4761",
                        "mainSeriesProperties.haStyle.drawWick": true,
                        "mainSeriesProperties.haStyle.drawBorder": true,
                        "mainSeriesProperties.haStyle.borderColor": "#3fcfb4",
                        "mainSeriesProperties.haStyle.borderUpColor": "#3fcfb4",
                        "mainSeriesProperties.haStyle.borderDownColor": "#fe4761",
                        "mainSeriesProperties.haStyle.wickColor": "#737375",
                        "mainSeriesProperties.haStyle.wickUpColor": "#3fcfb4",
                        "mainSeriesProperties.haStyle.wickDownColor": "#fe4761",
                        "mainSeriesProperties.haStyle.barColorsOnPrevClose": false,
                        "mainSeriesProperties.barStyle.upColor": "#3fcfb4",
                        "mainSeriesProperties.barStyle.downColor": "#fe4761",
                        "mainSeriesProperties.barStyle.barColorsOnPrevClose": false,
                        "mainSeriesProperties.barStyle.dontDrawOpen": false,
                        "mainSeriesProperties.lineStyle.color": "#0cbef3",
                        "mainSeriesProperties.lineStyle.linestyle": 0,
                        "mainSeriesProperties.lineStyle.linewidth": 1,
                        "mainSeriesProperties.lineStyle.priceSource": "close",
                        "mainSeriesProperties.areaStyle.color1": "#0cbef3",
                        "mainSeriesProperties.areaStyle.color2": "#0098c4",
                        "mainSeriesProperties.areaStyle.linecolor": "#0cbef3",
                        "mainSeriesProperties.areaStyle.linestyle": 0,
                        "mainSeriesProperties.areaStyle.linewidth": 1,
                        "mainSeriesProperties.areaStyle.priceSource": "close",
                        "mainSeriesProperties.areaStyle.transparency": 80
                    },
                    custom_css_url: 'chart.css'
        });
        chart.onChartReady(function(){
            // var kk = document.getElementById("kk")
           const btnList = [
                {
                //   label: local=="zh"?'分时':'Line',
                  label: 'Line',
                  resolution: "1",
                //   class: timers =='1' ? 'selected':'',   
                  class: label =='Line' ? 'selected':'',   
                  chartType: '1',
                //   class:label=='%E5%88%86%E6%97%B6'?'selected selected qwe':'',
                },  
                {
                //   label: local=="en"?'1min':'1分',
                  label: '1min',
                  resolution: "1",
                //   class:timers=='1'?'selected':'',
                  class:label=='1min'?'selected':'',
                  chartType: '1'
                },
                {
                //   label:local=="en"?'5min':'5分',
                  label:'5min',
                  resolution: "5",
                  class:timers=='5'?'selected':'',
                  chartType: '1'
                },
                {
                  label:"15min",
                //   label:local=="en"?'15min':'15分',
                  resolution: "15",
                  class:timers=='15'?'selected':'',
                  chartType: '1'

                },
                {
                  label:"30min",
                //   label:local=="en"?'30min':'30分',
                  resolution: "30",
                  class:timers=='30'?'selected':'',
                  chartType: '1'

                },
                {
                  label:"60min",
                //   label:local=="en"?'60min':'60分',
                  resolution: "60",
                  class:timers=='60'?'selected':'',
                  chartType: '1'

                },
                {
                  label:"4hour",
                //   label:local=="en"?'4H':'4时',
                  resolution: "240",
                  class:timers=='240'?'selected':'',
                  chartType: '1'

                },
                {
                  label:"1day",
                //   label:local=="en"?'1day':'日线',
                  resolution: "1D",
                  class:timers=='1D'?'selected':'',
                  chartType: '1'
                },
                // {
                //   label:local=="en"?'4H':'4时',
                //   resolution: "4H",
                //   class:timers=='4H'?'selected':'',
                // },
                {
                  label:"1week",
                //   label:local=="en"?'1W':'1周',
                  resolution: "1W",
                  class:timers=='1W'?'selected':'',
                  chartType: '1'
                },     
                {
                //   label:local=="en"?'1M':'1月',
                  label:"1mon",
                  resolution: "1M",
                  class:timers=='1M'?'selected':'',
                  chartType: '1'
                },   
                // {
                //   label:local=="en"?'1M':'1月',
                //   resolution: "1M",
                //   class:timers=='1M'?'selected':'',
                // },   
                
              ];
          btnList.forEach(function (item) {
            let button = chart.createButton({
              align: "left"
            });
            item.resolution === chart._options.interval && updateSelectedIntervalButton(button);
            button.attr('class', "button " + item.class).attr("data-chart-type", item.chartType === undefined ? 8 : item.chartType).on('click', function (e) {
              // if (!_self.chart.changingInterval && !button.hasClass("selected")) {
              let chartType = +button.attr("data-chart-type");
              // let resolution = button.attr("data-resolution");

            //   chart.chart().setResolution(item.resolution);
            //   window.location.href='/static/index.html?code='+CodeName+'&timers='+item.resolution+'&last_price='+last_price+'&label='+item.label;
            //   if (chart.chart().resolution() !== item.resolution ) {
                // _self.chart.chart().changingInterval = true;
                // 无用代码
                // chart.chart().setResolution(item.resolution);
                window.location.href='http://'+window.location.host+'/wap/static/index.html?code='+CodeName+'&timers='+item.resolution+'&last_price='+last_price+'&label='+item.label;
                    // window.location.href='/static/index.html?code='+CodeName+'&timers='+item.resolution+'&last_price='+last_price+'&label='+item.label;
            //   }

              if (chart.chart().chartType() !== chartType) {
                chart.chart().setChartType(chartType);
              }
              updateSelectedIntervalButton(button);
              // }
            }).append(item.label);
          });
          // widget.chart().createStudy('Moving Average', false, true, [5, "close", 0], null, {'Plot.color': "#7D53A8"});
          // widget.chart().createStudy('Moving Average', false, true, [10, "close", 0], null, {'Plot.color': "#7699C2"});
          // widget.chart().createStudy('Moving Average', false, true, [30, "close", 0], null, {'Plot.color': "#A0D75B"});
          function updateSelectedIntervalButton(button) {
            chart.selectedIntervalButton && chart.selectedIntervalButton.removeClass("selected");
            button.addClass("selected");
            chart.selectedIntervalButton = button;
          }
            if(timers==1 && label == "Line"){
                // if(label =='1min'){
                //     chart.chart().setChartType(1);
                // }else{
                    chart.chart().setChartType(3);
                // }
            }else{
                chart.chart().setChartType(1);
                chart.chart().createStudy('Moving Average',false,false,[5,'close',0],null,{'Plot.color':'red'});
                chart.chart().createStudy('Moving Average',false,false,[10,'close',0],null,{'Plot.color':'green'});
                chart.chart().createStudy('Moving Average',false,false,[30,'close',0],null,{'Plot.color':'blue'})
            }
            // chart.chart().onIntervalChanged().subscribe(null, function(interval, obj) {
            //     window.location.href='http://127.0.0.1/tradingview/index.html?code='+CodeName+'&timers='+interval;
            // });

            // 储存k线类型
            sessionStorage.setItem("cjhy-kline", label);
            sessionStorage.setItem("cjhy-kline-timers", timers);
        })
    });
    // 下单线
    let line = null;
    let text = "";
    var tsline = [];
    window.drawLine = function(obj, contract) {
        // console.log(obj)
        // console.log(label)
        var color = "";
        if (tsline.length) {
            tsline.forEach((val, index) => {
                tsline[index].remove();
            })
        }
        tsline = [];
        
        if (label == "Line") {
            obj.forEach((val, index) => {
                if (val.type == 1) { // 买涨
                    color = "#00bd82";
                } else {
                    color = "#ff5855";
                }

                if (contract == 1) { // 目标合约
                    text = `${parseFloat(obj[index].buyprice) + "   ↑" +  parseFloat(obj[index].stopwin) + "  ↓" + parseFloat(obj[index].stoploss)}`;
                } else { // 周期合约
                    if (val.type == "1") { // 买涨
                        text = `${parseFloat(obj[index].buyprice) + " ↑   " + timeTransfer(obj[index].addtime) + " → " + timeTransfer(obj[index].selltime)}`;
                    } else {
                        text = `${parseFloat(obj[index].buyprice) + " ↓   " + timeTransfer(obj[index].addtime) + " → " + timeTransfer(obj[index].selltime)}`;
                    }
                }
                
                tsline[index] = chart.chart()
                    .createPositionLine()
                    .setLineColor(color)
                    .setBodyBorderColor(color)
                    .setBodyBackgroundColor(color)
                    .setBodyTextColor("#fff")
                    .setQuantity("") 
                    .setText(text)
                    .setPrice(obj[index].buyprice) 
            })
        }
        


        // if (line) {
        //     line.remove();
        //     text = "";
        // }
        // if (type == 1) {
        //     text = "win:" + obj.stopwin + " loss:" + obj.stoploss
        // } else if (type == 2) {
        //     text = "s:" + obj.addtime + " e:" + obj.selltime
        // }
         
        // line = chart.chart()
        // .createPositionLine()
        // .setLineColor("rgb(255, 0, 0)")
        // .setBodyBorderColor("rgb(255, 0, 0)")
        // .setQuantity("") 
        // .setText(text)
        // .setPrice(obj.buyprice) 
    }

    window.removeLine = function () {
        // line.remove();
        if (tsline.length) {
            tsline.forEach((val, index) => {
                tsline[index].remove();
            })
        }
        tsline = [];
    }

    function timeTransfer(timestamp) {
        var date = new Date(timestamp * 1000) //时间戳为10位需*1000，时间戳为13位的话不需乘1000
        var Y, M, D, h, m, s
        Y = date.getFullYear() + '-'
        M = (date.getMonth() < 10 ? '0' + (date.getMonth() + 1) : date.getMonth() + 1) + '-'
        D = (date.getDate() < 10 ? '0' + (date.getDate()) : date.getDate()) + ' '
        h = (date.getHours() < 10 ? '0' + (date.getHours()) : date.getHours()) + ':'
        m = (date.getMinutes()< 10 ? '0' + (date.getMinutes()) : date.getMinutes()) + ':'
        s = (date.getSeconds()< 10 ? '0' + (date.getSeconds()) : date.getSeconds())
        return h + m + s 
    }
    
    function getChartData(url) {
        $.ajax({
            url:url,
            method:'GET',
            dataType:'json',
            async:true,
            success:function(response){
                if(response.status==200){
                    bars=[];
                    for (var i = 0; i < response.data.length; i++) {
                        if(timers=='1D'){
                            bars.unshift({
                                close: Number(response.data[i].closingPrice),
                                open: Number(response.data[i].openingPrice),
                                high: Number(response.data[i].highestPrice),
                                low: Number(response.data[i].lowestPrice),
                                volume: Number(response.data[i].volume),
                                time: (Number(response.data[i].timestamp)+8*3600)*1000,
                            })
                        }else{
                             bars.unshift({
                                close: Number(response.data[i].closingPrice),
                                open: Number(response.data[i].openingPrice),
                                high: Number(response.data[i].highestPrice),
                                low: Number(response.data[i].lowestPrice),
                                volume: Number(response.data[i].volume),
                                time: Number(response.data[i].timestamp)*1000,
                            })
                         }
                    }
                    // console.log(response.data[0].timestamp.substr(0, 9))
                    // overallTime = Math.floor(Division(response.data[0].timestamp.substr(0, 9), 60))
                    // console.log(overallTime)

                    overallTime = timestampToTime(response.data[0].timestamp)
                    // console.log(overallTime)
                    status=0;
                }
            }
        })
    }
    function createFeed(){
        let Datafeed = {};
        Datafeed.DataPulseUpdater = function(datafeed, updateFrequency) {
            this._datafeed = datafeed;
            this._subscribers = {};
            this._requestsPending = 0;
            var that = this;
            var update = function() {
                if (that._requestsPending > 0) {
                    return;
                }

                for (var listenerGUID in that._subscribers) {
                    var subscriptionRecord = that._subscribers[listenerGUID];
                    var resolution = subscriptionRecord.resolution;

                    var datesRangeRight = parseInt((new Date().valueOf()) / 1000);

                    //  BEWARE: please note we really need 2 bars, not the only last one
                    //  see the explanation below. `10` is the `large enough` value to work around holidays
                    var datesRangeLeft = datesRangeRight - that.periodLengthSeconds(resolution, 10);

                    that._requestsPending++;

                    (function(_subscriptionRecord) { // eslint-disable-line
                        that._datafeed.getBars(_subscriptionRecord.symbolInfo, resolution, datesRangeLeft, datesRangeRight, function(bars) {
                                that._requestsPending--;

                                //  means the subscription was cancelled while waiting for data
                                if (!that._subscribers.hasOwnProperty(listenerGUID)) {
                                    return;
                                }
                                if (bars.length === 0) {
                                    return;
                                }
                                var lastBar = bars[bars.length - 1];
                                if (!isNaN(_subscriptionRecord.lastBarTime) && lastBar.time < _subscriptionRecord.lastBarTime) {
                                    return;
                                }

                                var subscribers = _subscriptionRecord.listeners;

                                //  BEWARE: this one isn't working when first update comes and this update makes a new bar. In this case
                                //  _subscriptionRecord.lastBarTime = NaN
                                var isNewBar = !isNaN(_subscriptionRecord.lastBarTime) && lastBar.time > _subscriptionRecord.lastBarTime;

                                //  Pulse updating may miss some trades data (ie, if pulse period = 10 secods and new bar is started 5 seconds later after the last update, the
                                //  old bar's last 5 seconds trades will be lost). Thus, at fist we should broadcast old bar updates when it's ready.
                                if (isNewBar) {
                                    if (bars.length < 2) {
                                        throw new Error('Not enough bars in history for proper pulse update. Need at least 2.');
                                    }

                                    var previousBar = bars[bars.length - 2];
                                    for (var i = 0; i < subscribers.length; ++i) {
                                        subscribers[i](previousBar);
                                    }
                                }

                                _subscriptionRecord.lastBarTime = lastBar.time;

                                for (var i = 0; i < subscribers.length; ++i) {
                                    subscribers[i](lastBar);
                                }
                            },

                            //  on error
                            function() {
                                that._requestsPending--;
                            });
                    })(subscriptionRecord);
                }
            };

            if (typeof updateFrequency != 'undefined' && updateFrequency > 0) {
                setInterval(update, updateFrequency);
            }
        };
        Datafeed.DataPulseUpdater.prototype.periodLengthSeconds = function(resolution, requiredPeriodsCount) {
            var daysCount = 0;
            if (resolution === 'D') {
                daysCount = requiredPeriodsCount;
            } else if (resolution === 'M') {
                daysCount = 31 * requiredPeriodsCount;
            } else if (resolution === 'W') {
                daysCount = 7 * requiredPeriodsCount;
            } else {
                daysCount = requiredPeriodsCount * resolution / (24 * 60);
            }

            return daysCount * 24 * 60 * 60;
        };
        Datafeed.DataPulseUpdater.prototype.subscribeDataListener = function(symbolInfo, resolution, newDataCallback, listenerGUID) {
            this._datafeed._logMessage('Subscribing ' + listenerGUID);

            if (!this._subscribers.hasOwnProperty(listenerGUID)) {
                this._subscribers[listenerGUID] = {
                    symbolInfo: symbolInfo,
                    resolution: resolution,
                    lastBarTime: NaN,
                    listeners: []
                };
            }

            this._subscribers[listenerGUID].listeners.push(newDataCallback);
        };

        Datafeed.DataPulseUpdater.prototype.unsubscribeDataListener = function(listenerGUID) {
            this._datafeed._logMessage('Unsubscribing ' + listenerGUID);
            delete this._subscribers[listenerGUID];
        };

        Datafeed.Container = function(updateFrequency){
            this._configuration = {
                supports_search: false,
                supports_group_request: false,
                supported_resolutions: ['1', '5', '15', '30', '60', '1D', '1M', '1W'],
                supports_marks: true,
                supports_timescale_marks: true,
                exchanges: ['myExchange'],
                minmov : 1,
                pricecale : 10000,
            };

            this._barsPulseUpdater = new Datafeed.DataPulseUpdater(this, updateFrequency || 10 * 1000);
            // this._quotesPulseUpdater = new Datafeed.QuotesPulseUpdater(this);

            this._enableLogging = true;
            this._callbacks = {};

            this._initializationFinished = true;
            this._fireEvent('initialized');
            this._fireEvent('configuration_ready');
        };

        Datafeed.Container.prototype._fireEvent = function(event, argument) {
            if (this._callbacks.hasOwnProperty(event)) {
                var callbacksChain = this._callbacks[event];
                for (var i = 0; i < callbacksChain.length; ++i) {
                    callbacksChain[i](argument);
                }

                this._callbacks[event] = [];
            }
        };

        Datafeed.Container.prototype._logMessage = function(message) {
            if (this._enableLogging) {
                var now = new Date();
                // console.log("CHART LOGS: "+now.toLocaleTimeString() + '.' + now.getMilliseconds() + '> ' + message);
            }
        };

        Datafeed.Container.prototype.on = function(event, callback) {
            if (!this._callbacks.hasOwnProperty(event)) {
                this._callbacks[event] = [];
            }

            this._callbacks[event].push(callback);
            return this;
        };

        Datafeed.Container.prototype.onReady = function(callback) {
            let that = this;
            if (this._configuration) {
                setTimeout(function() {
                    callback(that._configuration);
                }, 0);
            }
            else {
                this.on('configuration_ready', function() {
                    callback(that._configuration);
                });
            }
        };

        Datafeed.Container.prototype.resolveSymbol = function(symbolName, onSymbolResolvedCallback, onResolveErrorCallback) {
            this._logMessage("GOWNO :: resolve symbol "+ symbolName);
            Promise.resolve().then(() => {
                function adjustScale(){
                    if(last_price.split('.')[1]){
                        let len=last_price.split('.')[1].length;
                        switch (len) {
                            case 1:
                                return 10;
                                break;
                            case 2:
                                return 100;
                                break;
                            case 3:
                                return 1000;
                                break;
                            case 4:
                                return 10000;
                                break;
                            case 5:
                                return 100000;
                                break;
                            case 6:
                                return 1000000;
                                break;
                            case 7:
                                return 10000000;
                                break;
                            case 8:
                                return 100000000;
                                break;
                            default:
                                // statements_def
                                break;
                        }
                    }else{
                        return 100;
                    }
                }
                this._logMessage("GOWNO :: onResultReady inject "+currency1 + ":"+ currency2);
                onSymbolResolvedCallback({
                    "name": currency1 + ":"+ currency2,
                    "timezone": "Asia/shanghai",
                    "pricescale": adjustScale(),
                    "minmov": 1,
                    "minmov2": 0,
                    "ticker": currency1 + ":"+ currency2,
                    "description": "",
                    "session": "24x7",
                    "type": "bitcoin",
                    "exchange-traded": "myExchange",
                    "exchange-listed": "myExchange",
                    "has_intraday": true,
                    "intraday_multipliers": ['1', '5', '15', '30', '60', '1D', '1W', '1M'], //It is an array containing intraday resolutions (in minutes) the datafeed wants to build by itself. E.g., if the datafeed reported he supports resolutions ["1", "5", "15"], but in fact it has only 1 minute bars for symbol X, it should set intraday_multipliers of X = [1]. This will make Charting Library to build 5 and 15 resolutions by itself.
                    "has_weekly_and_monthly": false,
                    "has_no_volume": false,
                    "regular_session": "24x7"
                });
            })
        };
        Datafeed.Container.prototype.getBars = function(symbolInfo, resolution, rangeStartDate, rangeEndDate, onDataCallback, onErrorCallback) {
            if (rangeStartDate > 0 && (rangeStartDate + '').length > 10) {
                throw new Error(['Got a JS time instead of Unix one.', rangeStartDate, rangeEndDate]);
            }
            onDataCallback([], { noData: true });
            //onDataCallback(bars, { noData: true , nextTime: data.nb || data.nextTime });
        };
        Datafeed.Container.prototype.subscribeBars = function(symbolInfo, resolution, onRealtimeCallback, listenerGUID, onResetCacheNeededCallback, resetData) {
                var _this=this; 
                timer_kline=setInterval(function(){
                    if(status=='0'){
                        loading.style.display="none";
                        _this.on('pair_change', function() {
                            onResetCacheNeededCallback();
                        });
                        onResetCacheNeededCallback();
                        // chart.activeChart().resetData();
                        if(pushtimer){
                            clearInterval(pushtimer);
                        }
                        switch(resolution){
                            case '1':
                               timer=15000;
                                break;
                            case '5':
                               timer=180000;
                                break;
                            case '15':
                               timer=480000;
                                break;
                            case '30':
                               timer=900000;
                                break;
                            case '60':
                               timer=1800000;
                                break;
                            case '1D':
                                break;
                        }
                        clearInterval(timer_kline);
                        bars.forEach(function (bar) { // in subscribeBars
                            onRealtimeCallback(bar)
                        });
                        setTimeout(function(){
                            if (MainData) {
                                clearInterval(timerws); 
                            }
                            // 首先判断是否 支持 WebSocket
                            if('WebSocket' in window) {
                                MainData = new WebSocket(wsurl);
                            } else if('MozWebSocket' in window) {
                                MainData = new MozWebSocket(wsurl);
                            } else {
                                MainData = new SockJS(wsurl);
                            };
                            // 打开时
                            MainData.onopen = function(evnt) {
                                var msg = {
                                    // sub: 'ticker.' + CodeName.toLowerCase()
                                    code: CodeName
                                };
                                MainData.send(JSON.stringify(msg)); // 发送消息
                                // timerws = setInterval(function() { 
                                //     var mm = {pong: new Date().getTime()};
                                //     MainData.send(JSON.stringify(mm));
                                // }, 25000)
                            };
                            
                            // 处理消息时
                            MainData.onmessage = function(evnt) {
                                var datanum;
                                datanum = JSON.parse(evnt.data);
                                datanijao = bars[bars.length-1];
                                timedatashuju = "";
                                let newdata;
                                if(datanum.name == CodeName){
                                    if (label == "1min") {
                                        newdata={
                                            close: Number(datanum.price),
                                            open: bars[bars.length-1].open,
                                            high: bars[bars.length-1].high,
                                            low: bars[bars.length-1].low,
                                            volume: bars[bars.length-1].volume,
                                            time: bars[bars.length-1].time,
                                        };
                                        

                                        // let tstime = Math.floor(Division(String(datanum.timestamp).substr(0, 9), 60))
                                        let tstime = timestampToTime(datanum.timestamp)
                                        if (tstime > overallTime) {
                                            // newdata.time = Number(String(datanum.timestamp).substr(0,9)+"0000");
                                            // bars[bars.length-1].time = Number(String(datanum.timestamp).substr(0,9)+"0000");
                                            // bars[bars.length-1].open = Number(datanum.close)
                                            bars[bars.length-1].open = Number(datanum.close)
                                            bars[bars.length-1].close = Number(datanum.price)
                                            bars[bars.length-1].high = Number(datanum.price)
                                            bars[bars.length-1].low = Number(datanum.price)
                                            // bars[bars.length-1].volume = Number(datanum.volume)
                                            bars[bars.length-1].time = tstime
                                            bars[bars.length-1].time = tstime
                                            newdata = bars[bars.length-1]
                                            overallTime = tstime;
                                            onRealtimeCallback(newdata);
                                            // onResetCacheNeededCallback()
                                            // chart.activeChart().resetData();
                                        } else {
                                            bars[bars.length-1].close = Number(datanum.price);
                                            if(datanijao.high < Number(datanum.price)){
                                                newdata.high = Number(datanum.price);
                                                // bars[bars.length-1].high = Number(datanum.price)
                                            };
                                            if(datanijao.low > Number(datanum.price)){
                                                newdata.low = Number(datanum.price);
                                                // bars[bars.length-1].low = Number(datanum.price)
                                            };
                                            // if(datanijao.close > Number(datanum.price)){
                                            //     newdata.close = Number(datanum.price);
                                            // };
                                            onRealtimeCallback(newdata);
                                        }
                                        
                                        
                                    } else {
                                        newdata={
                                            close: Number(datanum.price),
                                            open: bars[bars.length-1].open,
                                            high: bars[bars.length-1].high,
                                            low: bars[bars.length-1].low,
                                            volume: bars[bars.length-1].volume,
                                            time:bars[bars.length-1].time,
                                        };
                                        onRealtimeCallback(newdata);
                                    }

                                    
                                    
                                    // console.log(String(datanum.timestamp).substr(0,9));
                                    // console.log(String(newdata.time).substr(0,9))
                                    // if(datanum.name == CodeName){
                                    //     let newdata={
                                    //         close: Number(datanum.price),
                                    //         open: bars[bars.length-1].open,
                                    //         high: bars[bars.length-1].high,
                                    //         low: bars[bars.length-1].low,
                                    //         volume: bars[bars.length-1].volume,
                                    //         time:bars[bars.length-1].time,
                                    //     };
                                    //     onRealtimeCallback(newdata);
                                    // }
                                    
                                    // console.log(bars[bars.length-1]);
                                    // console.log(newdata)
                                    
                                }
                            };
                           MainData.onerror = function(evnt) {
                                console.log("websocket.onerror4");
                               MainData.onopen();
                            };
                           MainData.onclose = function(evnt) {
                                console.log("websocket.onclose4");
                                clearInterval(timerws)
                            };
                        },800)
                        // var getdatashuju = [];
                        if(resolution!='1D'){
                            pushtimer = setInterval(function(){
                                switch(resolution){
                                    case '1':
                                    //    getChartData(dataurl+'minute&code='+CodeName);
                                    //    onRealtimeCallback(bars);
                                    //    chart.activeChart().resetData();
                                        break;
                                    case '5':
                                       getChartData(dataurl+'minute5&code='+CodeName);
                                    //    chart.activeChart().resetData();
                                        break;
                                    case '15':
                                       getChartData(dataurl+'minute15&code='+CodeName);
                                    //    chart.activeChart().resetData();
                                        break;
                                    case '30':
                                       getChartData(dataurl+'minute30&code='+CodeName);
                                    //    chart.activeChart().resetData();
                                       break;
                                    case '60':
                                       getChartData(dataurl+'minute60&code='+CodeName);
                                    //    chart.activeChart().resetData();
                                        break;
                                }
                            },timer)
                        }
                    }
                },200)
                
               
            //this._barsPulseUpdater.subscribeDataListener(symbolInfo, resolution, onRealtimeCallback, listenerGUID, onResetCacheNeededCallback);
        };
        Datafeed.Container.prototype.unsubscribeBars = function(listenerGUID) {
            this._barsPulseUpdater.unsubscribeDataListener(listenerGUID);
        };

        return new Datafeed.Container;
    }
    function adjustChart(){
        let chart_iframe = $("#chart_container").find("iframe");
        let chart_top = chart_iframe.contents().find(".header-chart-panel");
        let chart_top_container = chart_iframe.contents().find(".header-chart-panel-content");
        let chart_bottom = chart_iframe.contents().find(".date-range-wrapper");

        chart_bottom.appendTo(chart_top_container);
    }
    function getCookie(name) { //读取cookie
        var arr, reg = new RegExp("(^| )" + name + "=([^;]*)(;|$)");
        if(arr = document.cookie.match(reg))
            return unescape(arr[2]);
        else
            return null;
    }
 </script>
</body>
</html>